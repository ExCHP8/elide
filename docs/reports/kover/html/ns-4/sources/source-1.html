


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > JsRuntime</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/highlight-idea.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">elide.runtime.graalvm</a>
</div>

<h1>Coverage Summary for Class: JsRuntime (elide.runtime.graalvm)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">JsRuntime</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (2/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    7%
  </span>
  <span class="absValue">
    (3/43)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    6.2%
  </span>
  <span class="absValue">
    (11/178)
  </span>
</td>
</tr>
  <tr>
    <td class="name">JsRuntime$Companion</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (2/3)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    25%
  </span>
  <span class="absValue">
    (2/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    4.5%
  </span>
  <span class="absValue">
    (1/22)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JsRuntime$EmbeddedScript</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (3/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (5/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    85.7%
  </span>
  <span class="absValue">
    (12/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    85.8%
  </span>
  <span class="absValue">
    (97/113)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JsRuntime$ExecutableScript</td>
<td class="coverageStat">
  <span class="percent">
    33.3%
  </span>
  <span class="absValue">
    (1/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    41.7%
  </span>
  <span class="absValue">
    (5/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    47.8%
  </span>
  <span class="absValue">
    (22/46)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JsRuntime$LiteralScript</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JsRuntime$Script</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (2/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    83.3%
  </span>
  <span class="absValue">
    (5/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77.8%
  </span>
  <span class="absValue">
    (21/27)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JsRuntime$ScriptRuntime</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (2/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    35%
  </span>
  <span class="absValue">
    (7/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    46.6%
  </span>
  <span class="absValue">
    (27/58)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JsRuntime$ScriptRuntime$Companion</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (7/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    82.1%
  </span>
  <span class="absValue">
    (23/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    89.4%
  </span>
  <span class="absValue">
    (194/217)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    57.7%
  </span>
  <span class="absValue">
    (15/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    26%
  </span>
  <span class="absValue">
    (13/50)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    41.9%
  </span>
  <span class="absValue">
    (57/136)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    54.9%
  </span>
  <span class="absValue">
    (373/679)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<div class="sourceCode" id="sourceCode"><i class="no-highlight">1</i>&nbsp;package elide.runtime.graalvm
<i class="no-highlight">2</i>&nbsp;
<i class="no-highlight">3</i>&nbsp;import com.google.common.annotations.VisibleForTesting
<i class="no-highlight">4</i>&nbsp;import io.micronaut.context.annotation.Context
<i class="no-highlight">5</i>&nbsp;import io.micronaut.context.annotation.Factory
<i class="no-highlight">6</i>&nbsp;import kotlinx.serialization.json.Json
<i class="no-highlight">7</i>&nbsp;import org.graalvm.polyglot.Source
<i class="no-highlight">8</i>&nbsp;import org.graalvm.polyglot.Value
<i class="no-highlight">9</i>&nbsp;import java.io.FileNotFoundException
<i class="no-highlight">10</i>&nbsp;import java.nio.charset.Charset
<i class="no-highlight">11</i>&nbsp;import java.nio.charset.StandardCharsets
<i class="no-highlight">12</i>&nbsp;import java.util.concurrent.atomic.AtomicBoolean
<i class="no-highlight">13</i>&nbsp;
<i class="no-highlight">14</i>&nbsp;
<i class="no-highlight">15</i>&nbsp;/** JavaScript embedded runtime logic, for use on the JVM. */
<b class="fc"><i class="no-highlight">16</i>&nbsp;@Context class JsRuntime {</b>
<b class="fc"><i class="no-highlight">17</i>&nbsp;  companion object {</b>
<i class="no-highlight">18</i>&nbsp;    // Singleton instance.
<b class="fc"><i class="no-highlight">19</i>&nbsp;    private val singleton = JsRuntime()</b>
<i class="no-highlight">20</i>&nbsp;
<i class="no-highlight">21</i>&nbsp;    /** @return Static acquisition of the singleton JavaScript runtime. */
<b class="fc"><i class="no-highlight">22</i>&nbsp;    @JvmStatic fun acquire(): JsRuntime = singleton</b>
<i class="no-highlight">23</i>&nbsp;
<i class="no-highlight">24</i>&nbsp;    /** @return SDK VM context pre-built for JavaScript execution. */
<i class="no-highlight">25</i>&nbsp;    @JvmStatic @Factory private fun initializeContext(): org.graalvm.polyglot.Context {
<b class="nc"><i class="no-highlight">26</i>&nbsp;      return org.graalvm.polyglot.Context</b>
<b class="nc"><i class="no-highlight">27</i>&nbsp;        .newBuilder(&quot;js&quot;)</b>
<b class="nc"><i class="no-highlight">28</i>&nbsp;        .allowExperimentalOptions(true)</b>
<b class="nc"><i class="no-highlight">29</i>&nbsp;        .option(&quot;js.ecmascript-version&quot;, &quot;2020&quot;)</b>
<b class="nc"><i class="no-highlight">30</i>&nbsp;        .option(&quot;js.v8-compat&quot;, &quot;true&quot;)</b>
<b class="nc"><i class="no-highlight">31</i>&nbsp;        .build()</b>
<i class="no-highlight">32</i>&nbsp;    }
<i class="no-highlight">33</i>&nbsp;  }
<i class="no-highlight">34</i>&nbsp;
<i class="no-highlight">35</i>&nbsp;  /** Shortcuts for creating script descriptors. */
<b class="fc"><i class="no-highlight">36</i>&nbsp;  @Suppress(&quot;unused&quot;) object Script {</b>
<i class="no-highlight">37</i>&nbsp;    /** @return Embedded script container for the provided [path] (and [charset], defaulting to `UTF-8`). */
<b class="pc"><i class="no-highlight">38</i>&nbsp;    @JvmStatic fun embedded(path: String, charset: Charset = StandardCharsets.UTF_8): EmbeddedScript = EmbeddedScript(</b>
<b class="fc"><i class="no-highlight">39</i>&nbsp;      path = path,</b>
<b class="fc"><i class="no-highlight">40</i>&nbsp;      charset = charset,</b>
<b class="fc"><i class="no-highlight">41</i>&nbsp;    )</b>
<i class="no-highlight">42</i>&nbsp;
<i class="no-highlight">43</i>&nbsp;    /** @return Literal script container for the provided [script]. */
<b class="nc"><i class="no-highlight">44</i>&nbsp;    @JvmStatic fun literal(script: String, id: String): ExecutableScript = LiteralScript(id, script)</b>
<i class="no-highlight">45</i>&nbsp;  }
<i class="no-highlight">46</i>&nbsp;
<i class="no-highlight">47</i>&nbsp;  /** Script runtime manager. */
<b class="fc"><i class="no-highlight">48</i>&nbsp;  class ScriptRuntime {</b>
<b class="fc"><i class="no-highlight">49</i>&nbsp;    companion object {</b>
<i class="no-highlight">50</i>&nbsp;      private const val embeddedRoot = &quot;embedded&quot;
<i class="no-highlight">51</i>&nbsp;      private const val manifest = &quot;/$embeddedRoot/runtime/runtime-js.json&quot;
<b class="fc"><i class="no-highlight">52</i>&nbsp;      private val initialized: AtomicBoolean = AtomicBoolean(false)</b>
<i class="no-highlight">53</i>&nbsp;
<i class="no-highlight">54</i>&nbsp;      // Runtime pre-amble from which to clone and splice executable scripts.
<i class="no-highlight">55</i>&nbsp;      private var preamble: StringBuilder
<i class="no-highlight">56</i>&nbsp;
<i class="no-highlight">57</i>&nbsp;      // Runtime finalizer / loader function.
<i class="no-highlight">58</i>&nbsp;      private var loader: StringBuilder
<i class="no-highlight">59</i>&nbsp;
<b class="fc"><i class="no-highlight">60</i>&nbsp;      init {</b>
<b class="fc"><i class="no-highlight">61</i>&nbsp;        val (p, l) = initialize()</b>
<b class="fc"><i class="no-highlight">62</i>&nbsp;        preamble = p</b>
<b class="fc"><i class="no-highlight">63</i>&nbsp;        loader = l</b>
<b class="fc"><i class="no-highlight">64</i>&nbsp;      }</b>
<i class="no-highlight">65</i>&nbsp;
<i class="no-highlight">66</i>&nbsp;      // Load a JS artifact for runtime use from the JAR.
<i class="no-highlight">67</i>&nbsp;      @JvmStatic private fun loadArtifact(path: String): String {
<b class="fc"><i class="no-highlight">68</i>&nbsp;        return (</b>
<b class="pc"><i class="no-highlight">69</i>&nbsp;          JsRuntime::class.java.getResourceAsStream(&quot;/$embeddedRoot/runtime/$path&quot;) ?:</b>
<b class="nc"><i class="no-highlight">70</i>&nbsp;            throw FileNotFoundException(&quot;Unable to locate runtime JS resource $path&quot;)</b>
<b class="pc"><i class="no-highlight">71</i>&nbsp;        ).bufferedReader(StandardCharsets.UTF_8).use {</b>
<b class="fc"><i class="no-highlight">72</i>&nbsp;          it.readText()</b>
<i class="no-highlight">73</i>&nbsp;        }
<i class="no-highlight">74</i>&nbsp;      }
<i class="no-highlight">75</i>&nbsp;
<i class="no-highlight">76</i>&nbsp;      // Initialize the script runtime by loading artifacts mentioned in the manifest.
<i class="no-highlight">77</i>&nbsp;      @JvmStatic @Synchronized private fun initialize(): Pair&lt;StringBuilder, StringBuilder&gt; {
<b class="pc"><i class="no-highlight">78</i>&nbsp;        if (!initialized.get()) {</b>
<b class="fc"><i class="no-highlight">79</i>&nbsp;          initialized.compareAndSet(</b>
<b class="fc"><i class="no-highlight">80</i>&nbsp;            false,</b>
<b class="fc"><i class="no-highlight">81</i>&nbsp;            true</b>
<i class="no-highlight">82</i>&nbsp;          )
<i class="no-highlight">83</i>&nbsp;
<i class="no-highlight">84</i>&nbsp;          // resolve the stream
<b class="pc"><i class="no-highlight">85</i>&nbsp;          val manifestStream = ScriptRuntime::class.java.getResourceAsStream(</b>
<b class="fc"><i class="no-highlight">86</i>&nbsp;            manifest</b>
<b class="nc"><i class="no-highlight">87</i>&nbsp;          ) ?: throw IllegalStateException(</b>
<b class="nc"><i class="no-highlight">88</i>&nbsp;            &quot;Failed to resolve JS runtime manifest: &#39;$manifest&#39;. Please check that you have a dependency on &quot; +</b>
<i class="no-highlight">89</i>&nbsp;            &quot;&#39;graalvm-js&#39;, which is required to run embedded SSR scripts.&quot;
<i class="no-highlight">90</i>&nbsp;          )
<i class="no-highlight">91</i>&nbsp;
<i class="no-highlight">92</i>&nbsp;          // grab content
<b class="pc"><i class="no-highlight">93</i>&nbsp;          val manifestContent = manifestStream.bufferedReader().use { it.readText() }</b>
<i class="no-highlight">94</i>&nbsp;
<i class="no-highlight">95</i>&nbsp;          // deserialize as script runtime config
<b class="fc"><i class="no-highlight">96</i>&nbsp;          val config = Json.decodeFromString(</b>
<b class="fc"><i class="no-highlight">97</i>&nbsp;            JsRuntimeConfig.serializer(),</b>
<b class="fc"><i class="no-highlight">98</i>&nbsp;            manifestContent</b>
<i class="no-highlight">99</i>&nbsp;          )
<i class="no-highlight">100</i>&nbsp;
<i class="no-highlight">101</i>&nbsp;          // load each resource
<b class="fc"><i class="no-highlight">102</i>&nbsp;          val runtimePreamble = StringBuilder()</b>
<b class="fc"><i class="no-highlight">103</i>&nbsp;          config.artifacts.map {</b>
<b class="fc"><i class="no-highlight">104</i>&nbsp;            runtimePreamble.appendLine(loadArtifact(it.name))</b>
<i class="no-highlight">105</i>&nbsp;          }
<i class="no-highlight">106</i>&nbsp;
<i class="no-highlight">107</i>&nbsp;          // load entrypoint
<b class="fc"><i class="no-highlight">108</i>&nbsp;          val runtimeEntry = StringBuilder()</b>
<b class="pc"><i class="no-highlight">109</i>&nbsp;          if (config.entry.isNotBlank()) {</b>
<b class="fc"><i class="no-highlight">110</i>&nbsp;            runtimeEntry.appendLine(loadArtifact(config.entry))</b>
<i class="no-highlight">111</i>&nbsp;          }
<i class="no-highlight">112</i>&nbsp;
<b class="fc"><i class="no-highlight">113</i>&nbsp;          return (</b>
<b class="fc"><i class="no-highlight">114</i>&nbsp;            runtimePreamble to runtimeEntry</b>
<i class="no-highlight">115</i>&nbsp;          )
<i class="no-highlight">116</i>&nbsp;        } else {
<b class="nc"><i class="no-highlight">117</i>&nbsp;          throw IllegalStateException(</b>
<b class="nc"><i class="no-highlight">118</i>&nbsp;            &quot;Cannot initialize JS runtime twice&quot;</b>
<i class="no-highlight">119</i>&nbsp;          )
<i class="no-highlight">120</i>&nbsp;        }
<i class="no-highlight">121</i>&nbsp;      }
<i class="no-highlight">122</i>&nbsp;    }
<i class="no-highlight">123</i>&nbsp;
<i class="no-highlight">124</i>&nbsp;    /** @return */
<i class="no-highlight">125</i>&nbsp;    internal fun prepare(script: ExecutableScript): ExecutableScript {
<b class="nc"><i class="no-highlight">126</i>&nbsp;      val content = script.load()</b>
<b class="nc"><i class="no-highlight">127</i>&nbsp;      val container = StringBuilder()</b>
<b class="nc"><i class="no-highlight">128</i>&nbsp;      if (script.installShims) {</b>
<b class="nc"><i class="no-highlight">129</i>&nbsp;        container.append(</b>
<b class="nc"><i class="no-highlight">130</i>&nbsp;          preamble</b>
<i class="no-highlight">131</i>&nbsp;        )
<i class="no-highlight">132</i>&nbsp;      }
<b class="nc"><i class="no-highlight">133</i>&nbsp;      container.append(</b>
<b class="nc"><i class="no-highlight">134</i>&nbsp;        content</b>
<i class="no-highlight">135</i>&nbsp;      )
<b class="nc"><i class="no-highlight">136</i>&nbsp;      if (script.installEntry) {</b>
<b class="nc"><i class="no-highlight">137</i>&nbsp;        container.append(</b>
<b class="nc"><i class="no-highlight">138</i>&nbsp;          loader</b>
<i class="no-highlight">139</i>&nbsp;        )
<i class="no-highlight">140</i>&nbsp;      }
<b class="nc"><i class="no-highlight">141</i>&nbsp;      script.assignRendered(</b>
<b class="nc"><i class="no-highlight">142</i>&nbsp;        container</b>
<i class="no-highlight">143</i>&nbsp;      )
<b class="nc"><i class="no-highlight">144</i>&nbsp;      return script</b>
<i class="no-highlight">145</i>&nbsp;    }
<i class="no-highlight">146</i>&nbsp;  }
<i class="no-highlight">147</i>&nbsp;
<i class="no-highlight">148</i>&nbsp;  /** Embedded script descriptor object. */
<b class="fc"><i class="no-highlight">149</i>&nbsp;  sealed class ExecutableScript(</b>
<b class="fc"><i class="no-highlight">150</i>&nbsp;    internal val installShims: Boolean = true,</b>
<b class="fc"><i class="no-highlight">151</i>&nbsp;    internal val installEntry: Boolean = true,</b>
<b class="fc"><i class="no-highlight">152</i>&nbsp;    val invocationBase: String? = null,</b>
<b class="fc"><i class="no-highlight">153</i>&nbsp;    val invocationTarget: String? = null,</b>
<i class="no-highlight">154</i>&nbsp;  ) {
<i class="no-highlight">155</i>&nbsp;    private var renderedContent: StringBuilder? = null
<i class="no-highlight">156</i>&nbsp;
<i class="no-highlight">157</i>&nbsp;    /** @return The path or some module ID for the embedded script. */
<i class="no-highlight">158</i>&nbsp;    abstract fun getId(): String
<i class="no-highlight">159</i>&nbsp;
<i class="no-highlight">160</i>&nbsp;    /** @return Script content, loaded synchronously. */
<i class="no-highlight">161</i>&nbsp;    abstract fun load(): String
<i class="no-highlight">162</i>&nbsp;
<i class="no-highlight">163</i>&nbsp;    // Assign rendered preamble+script content before execution.
<i class="no-highlight">164</i>&nbsp;    internal fun assignRendered(builder: StringBuilder) {
<b class="nc"><i class="no-highlight">165</i>&nbsp;      renderedContent = builder</b>
<b class="nc"><i class="no-highlight">166</i>&nbsp;    }</b>
<i class="no-highlight">167</i>&nbsp;
<i class="no-highlight">168</i>&nbsp;    internal fun render(): Source {
<b class="nc"><i class="no-highlight">169</i>&nbsp;      val content = renderedContent?.toString() ?: throw IllegalStateException(</b>
<b class="nc"><i class="no-highlight">170</i>&nbsp;        &quot;Cannot render script before it has been prepared by the JS runtime&quot;</b>
<i class="no-highlight">171</i>&nbsp;      )
<b class="nc"><i class="no-highlight">172</i>&nbsp;      return Source.create(</b>
<b class="nc"><i class="no-highlight">173</i>&nbsp;        &quot;js&quot;,</b>
<b class="nc"><i class="no-highlight">174</i>&nbsp;        content</b>
<i class="no-highlight">175</i>&nbsp;      )
<i class="no-highlight">176</i>&nbsp;    }
<i class="no-highlight">177</i>&nbsp;  }
<i class="no-highlight">178</i>&nbsp;
<i class="no-highlight">179</i>&nbsp;  /** Embedded script implementation which pulls from local JAR resources. */
<b class="pc"><i class="no-highlight">180</i>&nbsp;  class EmbeddedScript(</b>
<b class="fc"><i class="no-highlight">181</i>&nbsp;    val path: String,</b>
<b class="fc"><i class="no-highlight">182</i>&nbsp;    private val charset: Charset = StandardCharsets.UTF_8,</b>
<b class="fc"><i class="no-highlight">183</i>&nbsp;    invocationBase: String? = null,</b>
<b class="fc"><i class="no-highlight">184</i>&nbsp;    invocationTarget: String? = null,</b>
<b class="fc"><i class="no-highlight">185</i>&nbsp;  ): ExecutableScript(</b>
<b class="fc"><i class="no-highlight">186</i>&nbsp;    invocationBase = invocationBase,</b>
<b class="fc"><i class="no-highlight">187</i>&nbsp;    invocationTarget = invocationTarget,</b>
<i class="no-highlight">188</i>&nbsp;  ) {
<i class="no-highlight">189</i>&nbsp;    /** @inheritDoc */
<b class="nc"><i class="no-highlight">190</i>&nbsp;    override fun getId(): String = path</b>
<i class="no-highlight">191</i>&nbsp;
<i class="no-highlight">192</i>&nbsp;    /** @inheritDoc */
<i class="no-highlight">193</i>&nbsp;    override fun load(): String {
<b class="pc"><i class="no-highlight">194</i>&nbsp;      val stream = javaClass.getResourceAsStream(path) ?:</b>
<b class="nc"><i class="no-highlight">195</i>&nbsp;      throw FileNotFoundException(&quot;Embedded script not found: &#39;$path&#39;&quot;)</b>
<i class="no-highlight">196</i>&nbsp;
<b class="pc"><i class="no-highlight">197</i>&nbsp;      return stream.bufferedReader(charset).use {</b>
<b class="fc"><i class="no-highlight">198</i>&nbsp;        it.readText()</b>
<i class="no-highlight">199</i>&nbsp;      }
<i class="no-highlight">200</i>&nbsp;    }
<b class="fc"><i class="no-highlight">201</i>&nbsp;  }</b>
<i class="no-highlight">202</i>&nbsp;
<i class="no-highlight">203</i>&nbsp;  /** Embedded script implementation which pulls from a string literal. */
<i class="no-highlight">204</i>&nbsp;  class LiteralScript(
<b class="nc"><i class="no-highlight">205</i>&nbsp;    private val moduleId: String,</b>
<b class="nc"><i class="no-highlight">206</i>&nbsp;    private val script: String</b>
<b class="nc"><i class="no-highlight">207</i>&nbsp;  ): ExecutableScript() {</b>
<i class="no-highlight">208</i>&nbsp;    /** @inheritDoc */
<b class="nc"><i class="no-highlight">209</i>&nbsp;    override fun getId(): String = moduleId</b>
<i class="no-highlight">210</i>&nbsp;
<i class="no-highlight">211</i>&nbsp;    /** @inheritDoc */
<i class="no-highlight">212</i>&nbsp;    override fun load(): String {
<b class="nc"><i class="no-highlight">213</i>&nbsp;      return script</b>
<i class="no-highlight">214</i>&nbsp;    }
<i class="no-highlight">215</i>&nbsp;  }
<i class="no-highlight">216</i>&nbsp;
<i class="no-highlight">217</i>&nbsp;  // Create the singleton script runtime.
<b class="fc"><i class="no-highlight">218</i>&nbsp;  private val runtime: ScriptRuntime = ScriptRuntime()</b>
<i class="no-highlight">219</i>&nbsp;
<i class="no-highlight">220</i>&nbsp;  @VisibleForTesting
<i class="no-highlight">221</i>&nbsp;  internal fun &lt;R&gt; evalExecuteScript(
<i class="no-highlight">222</i>&nbsp;    context: org.graalvm.polyglot.Context,
<i class="no-highlight">223</i>&nbsp;    script: ExecutableScript,
<i class="no-highlight">224</i>&nbsp;    returnType: Class&lt;R&gt;,
<i class="no-highlight">225</i>&nbsp;    vararg arguments: Any?
<i class="no-highlight">226</i>&nbsp;  ): R? {
<b class="nc"><i class="no-highlight">227</i>&nbsp;    val interpreted = context.eval(</b>
<b class="nc"><i class="no-highlight">228</i>&nbsp;      runtime.prepare(script).render()</b>
<b class="nc"><i class="no-highlight">229</i>&nbsp;    ) ?: throw IllegalStateException(</b>
<b class="nc"><i class="no-highlight">230</i>&nbsp;      &quot;Failed to interpret script: &#39;${script.getId()}&#39;&quot;</b>
<i class="no-highlight">231</i>&nbsp;    )
<i class="no-highlight">232</i>&nbsp;
<b class="nc"><i class="no-highlight">233</i>&nbsp;    val base = script.invocationBase</b>
<b class="nc"><i class="no-highlight">234</i>&nbsp;    val target = script.invocationTarget</b>
<b class="nc"><i class="no-highlight">235</i>&nbsp;    val baseTarget: Value = if (target != null) {</b>
<b class="nc"><i class="no-highlight">236</i>&nbsp;      var baseSegment: Value = interpreted</b>
<b class="nc"><i class="no-highlight">237</i>&nbsp;      val baseResolved = if (base != null) {</b>
<b class="nc"><i class="no-highlight">238</i>&nbsp;        base.split(&quot;.&quot;).forEach {</b>
<b class="nc"><i class="no-highlight">239</i>&nbsp;          baseSegment = baseSegment.getMember(</b>
<b class="nc"><i class="no-highlight">240</i>&nbsp;            it</b>
<b class="nc"><i class="no-highlight">241</i>&nbsp;          ) ?: throw IllegalStateException(</b>
<b class="nc"><i class="no-highlight">242</i>&nbsp;            &quot;Failed to resolve base segment: &#39;$it&#39; in &#39;$base&#39; was not found&quot;</b>
<i class="no-highlight">243</i>&nbsp;          )
<b class="nc"><i class="no-highlight">244</i>&nbsp;        }</b>
<b class="nc"><i class="no-highlight">245</i>&nbsp;        baseSegment</b>
<i class="no-highlight">246</i>&nbsp;      } else {
<b class="nc"><i class="no-highlight">247</i>&nbsp;        interpreted</b>
<i class="no-highlight">248</i>&nbsp;      }
<i class="no-highlight">249</i>&nbsp;
<i class="no-highlight">250</i>&nbsp;      // from the resolved base segment, pluck the executable member
<b class="nc"><i class="no-highlight">251</i>&nbsp;      val found = baseResolved.getMember(</b>
<b class="nc"><i class="no-highlight">252</i>&nbsp;        script.invocationTarget,</b>
<b class="nc"><i class="no-highlight">253</i>&nbsp;      ) ?: throw IllegalStateException(</b>
<b class="nc"><i class="no-highlight">254</i>&nbsp;        &quot;Failed to invoke script member: &#39;${script.getId()}&#39; (fn: &#39;${script.invocationTarget}&#39;)&quot;</b>
<i class="no-highlight">255</i>&nbsp;      )
<i class="no-highlight">256</i>&nbsp;
<b class="nc"><i class="no-highlight">257</i>&nbsp;      if (!found.canExecute()) {</b>
<b class="nc"><i class="no-highlight">258</i>&nbsp;        throw IllegalStateException(</b>
<b class="nc"><i class="no-highlight">259</i>&nbsp;          &quot;Member found, but not executable, at &#39;${base}.${script.invocationTarget}&#39;&quot;</b>
<i class="no-highlight">260</i>&nbsp;        )
<i class="no-highlight">261</i>&nbsp;      } else {
<b class="nc"><i class="no-highlight">262</i>&nbsp;        found</b>
<i class="no-highlight">263</i>&nbsp;      }
<i class="no-highlight">264</i>&nbsp;    } else {
<i class="no-highlight">265</i>&nbsp;      // execute the script directly
<b class="nc"><i class="no-highlight">266</i>&nbsp;      interpreted</b>
<i class="no-highlight">267</i>&nbsp;    }
<i class="no-highlight">268</i>&nbsp;
<i class="no-highlight">269</i>&nbsp;    // if we are handed back an executable, execute it, providing the input arguments. in both cases, cast the return
<i class="no-highlight">270</i>&nbsp;    // value to the expected type.
<b class="nc"><i class="no-highlight">271</i>&nbsp;    return if (baseTarget.canExecute()) {</b>
<b class="nc"><i class="no-highlight">272</i>&nbsp;      baseTarget.execute(</b>
<b class="nc"><i class="no-highlight">273</i>&nbsp;        *arguments</b>
<b class="nc"><i class="no-highlight">274</i>&nbsp;      )?.`as`(</b>
<b class="nc"><i class="no-highlight">275</i>&nbsp;        returnType</b>
<i class="no-highlight">276</i>&nbsp;      )
<i class="no-highlight">277</i>&nbsp;    } else {
<b class="nc"><i class="no-highlight">278</i>&nbsp;      interpreted.`as`(</b>
<b class="nc"><i class="no-highlight">279</i>&nbsp;        returnType</b>
<i class="no-highlight">280</i>&nbsp;      )
<i class="no-highlight">281</i>&nbsp;    }
<i class="no-highlight">282</i>&nbsp;  }
<i class="no-highlight">283</i>&nbsp;
<i class="no-highlight">284</i>&nbsp;  /**
<i class="no-highlight">285</i>&nbsp;   * Asynchronously execute the provided [script] within an embedded JavaScript VM, by way of GraalVM&#39;s runtime engine;
<i class="no-highlight">286</i>&nbsp;   * de-serialize the result [R] and provide it as the return value.
<i class="no-highlight">287</i>&nbsp;   *
<i class="no-highlight">288</i>&nbsp;   * @param script Executable script spec to execute within the embedded JS VM.
<i class="no-highlight">289</i>&nbsp;   * @return Deferred task which evaluates to the return value [R] when execution finishes.
<i class="no-highlight">290</i>&nbsp;   */
<i class="no-highlight">291</i>&nbsp;  fun &lt;R&gt; execute(script: ExecutableScript, returnType: Class&lt;R&gt;, vararg arguments: Any?): R? {
<i class="no-highlight">292</i>&nbsp;    // interpret the script
<b class="nc"><i class="no-highlight">293</i>&nbsp;    val ctx = initializeContext()</b>
<b class="nc"><i class="no-highlight">294</i>&nbsp;    return ctx.use {</b>
<b class="nc"><i class="no-highlight">295</i>&nbsp;      evalExecuteScript(</b>
<b class="nc"><i class="no-highlight">296</i>&nbsp;        it,</b>
<b class="nc"><i class="no-highlight">297</i>&nbsp;        script,</b>
<b class="nc"><i class="no-highlight">298</i>&nbsp;        returnType,</b>
<b class="nc"><i class="no-highlight">299</i>&nbsp;        *arguments</b>
<i class="no-highlight">300</i>&nbsp;      )
<i class="no-highlight">301</i>&nbsp;    }
<i class="no-highlight">302</i>&nbsp;  }
<i class="no-highlight">303</i>&nbsp;}
</div>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
        var codeBlock = document.getElementById('sourceCode');

        if (codeBlock) {
            hljs.highlightBlock(codeBlock);
        }
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-06-22 23:42</div>
</div>
</body>
</html>
